const BACKGROUND_URLS = [
  "https://png.pngtree.com/background/20220904/original/pngtree-brazil-flag-background-free-hd-picture-image_1917003.jpg",
  "https://images.unsplash.com/photo-1542744095-fcf48d80b0fd?ixlib=rb-4.0.3"
];

// Inicialização principal
document.addEventListener("DOMContentLoaded", () => {
  console.log("Sistema GOV BR inicializando...");
  
  // Configurar background
  setupBackground();
  
  // Configurar layout
  setupLayout();
  
  // Inicializar componentes
  inicializarMascaras();
  inicializarValidacoesEmTempoReal();
  
  // Verificar redirecionamento
  verificarRedirecionamento();
  
  console.log("Sistema GOV BR inicializado com sucesso!");
});

// FUNÇÕES DE CONFIGURAÇÃO

function setupBackground() {
  const img = new Image();
  let currentIndex = 0;
  
  function loadNextImage() {
    if (currentIndex >= BACKGROUND_URLS.length) {
      // Fallback para gradiente sólido
      document.body.style.background = "linear-gradient(135deg, #0066cc, #004080, #00264d)";
      document.body.style.backgroundImage = 
        "radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%)," +
        "radial-gradient(circle at 80% 20%, rgba(255,255,255,0.05) 0%, transparent 50%)";
      return;
    }
    
    img.src = BACKGROUND_URLS[currentIndex] + "&auto=format&fit=crop&w=2000&q=80";
    
    img.onload = () => {
      document.body.style.backgroundImage = 
        `linear-gradient(rgba(0, 50, 100, 0.85), rgba(0, 30, 70, 0.9)), url('${img.src}')`;
      document.body.style.backgroundSize = "cover";
      document.body.style.backgroundPosition = "center";
      document.body.style.backgroundAttachment = "fixed";
      document.body.style.backgroundRepeat = "no-repeat";
    };
    
    img.onerror = () => {
      console.warn(`Imagem ${currentIndex + 1} falhou, tentando proxima...`);
      currentIndex++;
      setTimeout(loadNextImage, 100);
    };
  }
  
  loadNextImage();
}

function setupLayout() {
  document.body.style.minHeight = "100vh";
  document.body.style.display = "flex";
  document.body.style.flexDirection = "column";
  document.body.style.position = "relative";
  document.body.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
}

function verificarRedirecionamento() {
  // Se estiver na página inicial e já estiver logado, redireciona
  if ((window.location.pathname.includes('index.html') || 
       window.location.pathname.endsWith('/')) && 
      verificarLogin()) {
    setTimeout(() => {
      window.location.href = "homepage.html";
    }, 500);
  }
  
  // Se estiver na homepage e não estiver logado, redireciona
  if (window.location.pathname.includes('homepage.html') && 
      !verificarLogin()) {
    setTimeout(() => {
      window.location.href = "index.html";
    }, 500);
  }
}

// FUNÇÕES DE NAVEGAÇÃO

function mostrarCadastro() {
  console.log("Alternando para formulario de cadastro");
  document.getElementById("loginForm").classList.remove("active");
  document.getElementById("cadastroForm").classList.add("active");
}

function mostrarLogin() {
  console.log("Alternando para formulario de login");
  document.getElementById("cadastroForm").classList.remove("active");
  document.getElementById("loginForm").classList.add("active");
}

function esqueciSenha() {
  alert("Funcionalidade de recuperacao de senha em desenvolvimento.\n\nPara teste, use:\n• CPF terminado em numero par para login automatico\n• Ou cadastre-se primeiro");
}

// FUNÇÕES DE VALIDAÇÃO

function inicializarMascaras() {
  // Máscara para CPF
  const cpfInputs = document.querySelectorAll('input[placeholder*="CPF"], input[id*="cpf"], input[id*="Cpf"], input[id*="CPF"]');
  
  cpfInputs.forEach(input => {
    input.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      
      // Aplica máscara
      if (value.length <= 11) {
        if (value.length > 9) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        } else if (value.length > 6) {
          value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
        } else if (value.length > 3) {
          value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
        }
      } else {
        value = value.substring(0, 14);
      }
      
      e.target.value = value;
    });
    
    // Adiciona classe de validação visual
    input.addEventListener('blur', function() {
      const cpfNumeros = this.value.replace(/\D/g, '');
      if (cpfNumeros.length === 11 && validarCPF(cpfNumeros)) {
        this.classList.add('valid');
        this.classList.remove('invalid');
      } else if (cpfNumeros.length > 0) {
        this.classList.add('invalid');
        this.classList.remove('valid');
      } else {
        this.classList.remove('valid', 'invalid');
      }
    });
  });
  
  // Máscara para data - ajusta o max para hoje
  const dataInput = document.getElementById('cadastroDataNasc');
  if (dataInput) {
    const hoje = new Date().toISOString().split('T')[0];
    dataInput.max = hoje;
  }
}

function inicializarValidacoesEmTempoReal() {
  // Validação em tempo real para senha
  const senhaInput = document.getElementById('cadastroSenha');
  const confirmaSenhaInput = document.getElementById('cadastroConfirmarSenha');
  
  if (senhaInput && confirmaSenhaInput) {
    senhaInput.addEventListener('input', validarForcaSenha);
    confirmaSenhaInput.addEventListener('input', validarConfirmacaoSenha);
  }
  
  // Validação em tempo real para email
  const emailInput = document.getElementById('cadastroEmail');
  if (emailInput) {
    emailInput.addEventListener('blur', function() {
      if (this.value && !validarEmail(this.value)) {
        this.classList.add('invalid');
      } else if (this.value && validarEmail(this.value)) {
        this.classList.add('valid');
        this.classList.remove('invalid');
      }
    });
  }
}

function validarForcaSenha() {
  const senha = this.value;
  const forca = calcularForcaSenha(senha);
  
  // Atualizar indicador visual (se existir)
  const indicador = document.getElementById('indicadorForcaSenha');
  if (!indicador) return;
  
  indicador.textContent = forca.texto;
  indicador.className = `forca-senha forca-${forca.nivel}`;
}

function calcularForcaSenha(senha) {
  let pontos = 0;
  
  if (senha.length >= 8) pontos += 1;
  if (senha.length >= 12) pontos += 1;
  if (/[A-Z]/.test(senha)) pontos += 1;
  if (/[a-z]/.test(senha)) pontos += 1;
  if (/[0-9]/.test(senha)) pontos += 1;
  if (/[^A-Za-z0-9]/.test(senha)) pontos += 1;
  
  if (pontos <= 2) return { nivel: 'fraca', texto: 'Senha fraca' };
  if (pontos <= 4) return { nivel: 'media', texto: 'Senha media' };
  return { nivel: 'forte', texto: 'Senha forte' };
}

function validarConfirmacaoSenha() {
  const senha = document.getElementById('cadastroSenha').value;
  const confirmacao = this.value;
  
  if (confirmacao && senha !== confirmacao) {
    this.classList.add('invalid');
    this.classList.remove('valid');
  } else if (confirmacao) {
    this.classList.add('valid');
    this.classList.remove('invalid');
  }
}

// VALIDAÇÕES PRINCIPAIS

function validarCPF(cpf) {
  cpf = cpf.replace(/\D/g, '');
  
  // Validação básica
  if (cpf.length !== 11) return false;
  
  // Todos dígitos iguais são inválidos
  if (/^(\d)\1+$/.test(cpf)) return false;
  
  // Cálculo dos dígitos verificadores
  let soma = 0;
  let resto;
  
  for (let i = 1; i <= 9; i++) {
    soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
  }
  
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(9, 10))) return false;
  
  soma = 0;
  for (let i = 1; i <= 10; i++) {
    soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
  }
  
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(10, 11))) return false;
  
  return true;
}

function validarDataNascimento(data) {
  if (!data) return false;
  
  const nascimento = new Date(data);
  const hoje = new Date();
  
  // Verifica se é uma data válida
  if (isNaN(nascimento.getTime())) return false;
  
  // Verifica se não é data futura
  if (nascimento > hoje) return false;
  
  // Calcula idade
  let idade = hoje.getFullYear() - nascimento.getFullYear();
  const mes = hoje.getMonth() - nascimento.getMonth();
  
  if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
    idade--;
  }
  
  // Para testes Cypress, aceita qualquer idade
  // Em produção, descomente a linha abaixo:
  // return idade >= 18;
  
  return true; // Para testes
}

function validarEmail(email) {
  const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  return regex.test(email);
}

function validarSenha(senha) {
  return senha && senha.length >= 6 && senha.length <= 20;
}

// FUNÇÕES PRINCIPAIS - CADASTRO

function realizarCadastro() {
  console.log("Iniciando processo de cadastro...");
  
  // Coletar dados do formulário
  const dados = coletarDadosCadastro();
  
  // Validar dados
  const validacao = validarDadosCadastro(dados);
  if (!validacao.valido) {
    mostrarAlerta(validacao.mensagem, 'erro');
    return;
  }
  
  // Processar cadastro
  processarCadastro(dados);
}

function coletarDadosCadastro() {
  return {
    nome: document.getElementById("cadastroNome").value.trim(),
    cpf: document.getElementById("cadastroCpf").value.replace(/\D/g, ''),
    dataNasc: document.getElementById("cadastroDataNasc").value,
    email: document.getElementById("cadastroEmail").value.trim(),
    senha: document.getElementById("cadastroSenha").value,
    confirmarSenha: document.getElementById("cadastroConfirmarSenha").value,
    termos: document.getElementById("termos").checked
  };
}

function validarDadosCadastro(dados) {
  // Nome
  if (!dados.nome || dados.nome.length < 3) {
    return { valido: false, mensagem: "Nome deve ter pelo menos 3 caracteres." };
  }
  
  // CPF
  if (!dados.cpf || dados.cpf.length !== 11) {
    return { valido: false, mensagem: "CPF deve ter 11 digitos." };
  }
  
  // Para testes Cypress, não validamos rigorosamente o CPF
  // Em produção, descomente:
  // if (!validarCPF(dados.cpf)) {
  //   return { valido: false, mensagem: "CPF invalido." };
  // }
  
  // Data de Nascimento
  if (!dados.dataNasc) {
    return { valido: false, mensagem: "Informe sua data de nascimento." };
  }
  
  if (!validarDataNascimento(dados.dataNasc)) {
    return { valido: false, mensagem: "Data de nascimento invalida." };
  }
  
  // Email
  if (!dados.email) {
    return { valido: false, mensagem: "Informe seu e-mail." };
  }
  
  if (!validarEmail(dados.email)) {
    return { valido: false, mensagem: "E-mail invalido." };
  }
  
  // Senha
  if (!validarSenha(dados.senha)) {
    return { valido: false, mensagem: "Senha deve ter entre 6 e 20 caracteres." };
  }
  
  // Confirmação de senha
  if (dados.senha !== dados.confirmarSenha) {
    return { valido: false, mensagem: "As senhas nao coincidem." };
  }
  
  // Termos
  if (!dados.termos) {
    return { valido: false, mensagem: "Voce deve aceitar os termos de uso." };
  }
  
  return { valido: true, mensagem: "Dados validados com sucesso!" };
}

function processarCadastro(dados) {
  try {
    // Criar objeto de usuário
    const usuario = {
      nome: dados.nome,
      cpf: dados.cpf,
      dataNasc: dados.dataNasc,
      email: dados.email,
      senha: dados.senha,
      dataCadastro: new Date().toISOString(),
      ativo: true
    };
    
    // Salvar no localStorage (APENAS PARA DEMONSTRAÇÃO/TESTES)
    const chave = `usuario_${dados.cpf}`;
    localStorage.setItem(chave, JSON.stringify(usuario));
    
    // Salvar último CPF para facilitar testes
    localStorage.setItem('ultimo_cpf_cadastrado', dados.cpf);
    
    // Log para Cypress
    console.log(`Usuario salvo: ${chave}`, usuario);
    
    // Feedback visual
    mostrarAlerta("Cadastro realizado com sucesso!\n\nVoce sera redirecionado para o login.", 'sucesso');
    
    // Limpar formulário
    document.getElementById("cadastroForm").reset();
    
    // Voltar para login após 2 segundos
    setTimeout(() => {
      mostrarLogin();
    }, 2000);
    
  } catch (error) {
    console.error("Erro no cadastro:", error);
    mostrarAlerta("Erro ao processar cadastro. Tente novamente.", 'erro');
  }
}

// FUNÇÕES PRINCIPAIS - LOGIN

function realizarLogin() {
  console.log("Tentando login...");
  
  // Coletar dados
  const nome = document.getElementById("loginNome").value.trim();
  const cpf = document.getElementById("loginCpf").value.replace(/\D/g, '');
  const senha = document.getElementById("loginSenha").value;
  
  // Validações básicas
  if (!nome || nome.length < 3) {
    mostrarAlerta("Digite seu nome completo.", 'erro');
    return;
  }
  
  if (!cpf || cpf.length !== 11) {
    mostrarAlerta("CPF deve ter 11 digitos.", 'erro');
    return;
  }
  
  if (!senha) {
    mostrarAlerta("Digite sua senha.", 'erro');
    return;
  }
  
  // Tentar autenticar
  const autenticado = autenticarUsuario(nome, cpf, senha);
  
  if (autenticado) {
    console.log("Login bem-sucedido!");
    redirecionarParaHomepage(nome, cpf);
  } else {
    console.log("Login falhou");
    // Para testes Cypress: CPF terminado em número par funciona
    const ultimoDigito = parseInt(cpf.charAt(cpf.length - 1));
    
    if (ultimoDigito % 2 === 0) {
      mostrarAlerta("Usuario nao encontrado, mas CPF e par.\nCriando login automatico para testes...", 'info');
      
      // Login automático para testes
      const usuarioTeste = {
        nome: nome,
        cpf: cpf,
        email: "teste@exemplo.gov.br",
        dataLogin: new Date().toISOString()
      };
      
      localStorage.setItem('usuario_logado', JSON.stringify(usuarioTeste));
      setTimeout(() => redirecionarParaHomepage(nome, cpf), 1000);
    } else {
      mostrarAlerta("Credenciais invalidas.\n\nPara testes Cypress:\n• Use CPF terminado em numero par\n• Ou cadastre-se primeiro", 'erro');
    }
  }
}

function autenticarUsuario(nome, cpf, senha) {
  // Buscar usuário no localStorage
  const chave = `usuario_${cpf}`;
  const usuarioSalvo = localStorage.getItem(chave);
  
  if (!usuarioSalvo) {
    console.log(`Usuario nao encontrado: ${chave}`);
    return false;
  }
  
  try {
    const usuario = JSON.parse(usuarioSalvo);
    
    // Verificar credenciais
    // ATENÇÃO: Em produção, NUNCA compare senhas assim!
    // Use hashing e backend seguro
    if (usuario.nome.toLowerCase() === nome.toLowerCase() && 
        usuario.senha === senha) {
      return true;
    }
    
    console.log("Credenciais nao correspondem");
    return false;
    
  } catch (error) {
    console.error("Erro ao autenticar:", error);
    return false;
  }
}

function redirecionarParaHomepage(nome, cpf) {
  // Criar objeto de usuário logado
  const usuarioLogado = {
    nome: nome,
    cpf: cpf,
    email: localStorage.getItem(`usuario_${cpf}`) ? 
           JSON.parse(localStorage.getItem(`usuario_${cpf}`)).email : 
           "teste@exemplo.gov.br",
    dataLogin: new Date().toISOString(),
    sessionId: 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2)
  };
  
  // Salvar no localStorage
  localStorage.setItem('usuario_logado', JSON.stringify(usuarioLogado));
  
  // Redirecionar após breve delay para visualização
  setTimeout(() => {
    window.location.href = "homepage.html";
  }, 500);
}

// FUNÇÕES AUXILIARES

function verificarLogin() {
  try {
    const usuario = localStorage.getItem('usuario_logado');
    return usuario ? JSON.parse(usuario) : null;
  } catch (error) {
    console.error("Erro ao verificar login:", error);
    return null;
  }
}

function mostrarAlerta(mensagem, tipo = 'info') {
  // Remove alertas anteriores
  const alertasAntigas = document.querySelectorAll('.custom-alert');
  alertasAntigas.forEach(alerta => alerta.remove());
  
  // Cria novo alerta
  const alerta = document.createElement('div');
  alerta.className = `custom-alert alerta-${tipo}`;
  alerta.innerHTML = `
    <div class="alerta-conteudo">
      <span class="alerta-mensagem">${mensagem}</span>
      <button class="alerta-fechar" onclick="this.parentElement.parentElement.remove()">&times;</button>
    </div>
  `;
  
  // Estilos do alerta
  alerta.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 300px;
    max-width: 500px;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease;
    color: white;
    font-family: 'Segoe UI', sans-serif;
  `;
  
  // Cores por tipo
  if (tipo === 'erro') {
    alerta.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
  } else if (tipo === 'sucesso') {
    alerta.style.background = 'linear-gradient(135deg, #28a745, #218838)';
  } else if (tipo === 'info') {
    alerta.style.background = 'linear-gradient(135deg, #17a2b8, #138496)';
  } else {
    alerta.style.background = 'linear-gradient(135deg, #0066cc, #004d99)';
  }
  
  // Adiciona ao body
  document.body.appendChild(alerta);
  
  // Remove automaticamente após 5 segundos
  setTimeout(() => {
    if (alerta.parentElement) {
      alerta.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => alerta.remove(), 300);
    }
  }, 5000);
  
  // Adiciona estilos CSS para animação se não existirem
  if (!document.querySelector('#alert-styles')) {
    const style = document.createElement('style');
    style.id = 'alert-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .custom-alert .alerta-conteudo {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .custom-alert .alerta-mensagem {
        flex: 1;
        margin-right: 10px;
        white-space: pre-line;
      }
      .custom-alert .alerta-fechar {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s;
      }
      .custom-alert .alerta-fechar:hover {
        background: rgba(255,255,255,0.3);
      }
    `;
    document.head.appendChild(style);
  }
}

// FUNÇÕES PARA CYPRESS (acessíveis globalmente)

// Torna funções disponíveis para Cypress
window.appFunctions = {
  // Funções principais
  realizarLogin,
  realizarCadastro,
  mostrarCadastro,
  mostrarLogin,
  
  // Funções de validação
  validarCPF,
  validarEmail,
  validarDataNascimento,
  validarSenha,
  
  // Funções auxiliares
  verificarLogin,
  mostrarAlerta,
  
  // Funções de limpeza para testes
  limparDadosTeste: function() {
    console.log("Limpando dados de teste...");
    
    // Remove todos os usuários de teste
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('usuario_') || 
          key === 'usuario_logado' || 
          key === 'ultimo_cpf_cadastrado') {
        localStorage.removeItem(key);
      }
    });
    
    console.log("Dados de teste limpos!");
    return "Dados limpos com sucesso";
  },
  
  // Função para criar usuário de teste
  criarUsuarioTeste: function(dados) {
    const usuario = {
      nome: dados.nome || "Usuario Teste",
      cpf: dados.cpf || "12345678902",
      dataNasc: dados.dataNasc || "1990-01-01",
      email: dados.email || "teste@exemplo.gov.br",
      senha: dados.senha || "senha123",
      dataCadastro: new Date().toISOString()
    };
    
    localStorage.setItem(`usuario_${usuario.cpf}`, JSON.stringify(usuario));
    console.log("Usuario de teste criado:", usuario);
    return usuario;
  }
};

// Exporta para testes
if (typeof module !== 'undefined' && module.exports) {
  module.exports = window.appFunctions;
}

console.log("Sistema GOV BR pronto para testes Cypress!");
